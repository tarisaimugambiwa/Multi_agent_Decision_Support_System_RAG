{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }} - Medical AI System{% endblock %}

{% block extra_css %}
<style>
    .ai-assistance {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        color: white;
    }
    
    .form-section {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        border-left: 4px solid #007bff;
    }
    
    .patient-info {
        background: #e8f4f8;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
        display: none;
    }
    
    .triage-result {
        margin-top: 10px;
        padding: 10px;
        border-radius: 5px;
    }
    
    .triage-critical { background-color: #f8d7da; border-left: 4px solid #dc3545; }
    .triage-high { background-color: #fff3cd; border-left: 4px solid #ffc107; }
    .triage-moderate { background-color: #cce5ff; border-left: 4px solid #007bff; }
    .triage-low { background-color: #d4edda; border-left: 4px solid #28a745; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4><i class="fas fa-stethoscope me-2"></i>{{ title }}</h4>
                </div>
                <div class="card-body">
                    <!-- AI Assistance Banner -->
                    <div class="ai-assistance">
                        <h5><i class="fas fa-robot me-2"></i>AI-Powered Diagnosis</h5>
                        <p class="mb-0">Our AI system will analyze the symptoms and patient history to provide diagnostic suggestions and determine case urgency automatically.</p>
                    </div>

                    <form method="post" id="case-form">
                        {% csrf_token %}
                        
                        <!-- Patient Selection -->
                        <div class="form-section">
                            <h5><i class="fas fa-user me-2"></i>Patient Information</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="{{ form.patient.id_for_label }}" class="form-label">Patient *</label>
                                    {{ form.patient }}
                                    {% if form.patient.errors %}
                                        <div class="text-danger">{{ form.patient.errors }}</div>
                                    {% endif %}
                                    <div class="mt-2">
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Don't see the patient? 
                                            <a href="{% url 'patients:patient_create' %}" class="fw-bold" target="_blank">
                                                <i class="fas fa-plus-circle me-1"></i>Create New Patient
                                            </a>
                                            or 
                                            <a href="{% url 'patients:patient_list' %}" class="fw-bold" target="_blank">
                                                <i class="fas fa-search me-1"></i>View All Patients
                                            </a>
                                        </small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <button type="button" class="btn btn-outline-info mt-4" id="load-patient-history">
                                        <i class="fas fa-history me-2"></i>Load Patient History
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Patient History Display -->
                            <div id="patient-history" class="patient-info">
                                <h6><i class="fas fa-file-medical-alt me-2"></i>Patient History</h6>
                                <div id="history-content"></div>
                            </div>
                        </div>

                        <!-- Symptoms with Picture Upload -->
                        <div class="form-section">
                            <h5><i class="fas fa-notes-medical me-2"></i>Symptoms & Visual Documentation</h5>
                            
                            <!-- Picture Upload for Symptoms -->
                            <div class="mb-4">
                                <label class="form-label"><i class="fas fa-image me-2"></i>Upload Symptom Picture (Optional)</label>
                                <div class="card bg-light border-dashed" style="border: 2px dashed #007bff; padding: 30px; text-align: center; cursor: pointer;" id="imageDropZone">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                                    <p class="mb-2"><strong>Click to upload or drag and drop</strong></p>
                                    <p class="text-muted small">PNG, JPG, GIF up to 10MB</p>
                                    <input type="file" id="symptom_image" name="symptom_image" accept="image/*" style="display: none;" class="form-control">
                                </div>
                                
                                <!-- Image Preview -->
                                <div id="imagePreviewContainer" style="display: none; margin-top: 15px;">
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <img id="imagePreview" src="" alt="Symptom Preview" style="max-width: 100%; max-height: 300px; border-radius: 8px;">
                                                </div>
                                                <div class="col-md-6">
                                                    <h6><i class="fas fa-file-image me-2"></i>Image Details</h6>
                                                    <p><strong>File Name:</strong> <span id="fileName"></span></p>
                                                    <p><strong>File Size:</strong> <span id="fileSize"></span></p>
                                                    <p><strong>Upload Status:</strong> <span class="badge bg-success">Ready</span></p>
                                                    <button type="button" class="btn btn-sm btn-danger" onclick="clearImageUpload()" title="Delete this image and upload a new one if needed">
                                                        <i class="fas fa-trash me-1"></i>Remove Image
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Symptoms Description -->
                            <div>
                                <label for="{{ form.symptoms.id_for_label }}" class="form-label">Detailed Symptoms Description *</label>
                                {{ form.symptoms }}
                                {% if form.symptoms.errors %}
                                    <div class="text-danger">{{ form.symptoms.errors }}</div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    <i class="fas fa-lightbulb me-1"></i>
                                    Include: type of symptom, severity (mild/moderate/severe), duration, location, associated symptoms, and any observations from the picture if uploaded.
                                </small>
                            </div>
                        </div>

                        <!-- Vital Signs -->
                        <div class="form-section">
                            <h5><i class="fas fa-heartbeat me-2"></i>Vital Signs</h5>
                            <p class="text-muted small mb-3">Enter the patient's vital signs. Leave blank if not available.</p>
                            
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="temperature" class="form-label">Temperature (Â°C)</label>
                                    <input type="number" step="0.1" class="form-control" id="temperature" name="temperature" placeholder="37.5">
                                </div>
                                
                                <div class="col-md-6">
                                    <label for="weight" class="form-label">Weight (Kg)</label>
                                    <input type="number" step="0.1" class="form-control" id="weight" name="weight" placeholder="70">
                                </div>
                                
                                <div class="col-md-6">
                                    <label for="blood_pressure_systolic" class="form-label">BP Systolic (mmHg)</label>
                                    <input type="number" class="form-control" id="blood_pressure_systolic" name="blood_pressure_systolic" placeholder="120">
                                </div>
                                
                                <div class="col-md-6">
                                    <label for="blood_pressure_diastolic" class="form-label">BP Diastolic (mmHg)</label>
                                    <input type="number" class="form-control" id="blood_pressure_diastolic" name="blood_pressure_diastolic" placeholder="80">
                                </div>
                            </div>
                        </div>

                        <!-- Priority and Status -->
                        <div class="form-section">
                            <h5><i class="fas fa-exclamation-triangle me-2"></i>Case Priority</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="{{ form.priority.id_for_label }}" class="form-label">Priority Level</label>
                                    {{ form.priority }}
                                    {% if form.priority.errors %}
                                        <div class="text-danger">{{ form.priority.errors }}</div>
                                    {% endif %}
                                    <small class="form-text text-muted">AI will suggest priority based on symptoms if left as Medium</small>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% url 'diagnoses:case_list' %}" class="btn btn-secondary me-md-2">
                                <i class="fas fa-times me-2"></i>Cancel
                            </a>
                            <button type="submit" class="btn btn-primary" id="submit-btn">
                                <i class="fas fa-save me-2"></i>Create Case & Generate AI Diagnosis
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar with Help -->
        <div class="col-lg-4">
            <div class="card shadow">
                <div class="card-header bg-info text-white">
                    <h5><i class="fas fa-info-circle me-2"></i>AI Diagnosis Help</h5>
                </div>
                <div class="card-body">
                    <h6>How AI Diagnosis Works:</h6>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-search text-primary me-2"></i>Searches medical knowledge base</li>
                        <li><i class="fas fa-brain text-success me-2"></i>Applies clinical reasoning rules</li>
                        <li><i class="fas fa-chart-line text-warning me-2"></i>Calculates symptom severity</li>
                        <li><i class="fas fa-flag text-danger me-2"></i>Determines case urgency</li>
                    </ul>

                    <h6 class="mt-3">Tips for Better Results:</h6>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-check text-success me-2"></i>Describe symptoms clearly</li>
                        <li><i class="fas fa-check text-success me-2"></i>Include onset and duration</li>
                        <li><i class="fas fa-check text-success me-2"></i>Mention severity (mild/moderate/severe)</li>
                        <li><i class="fas fa-check text-success me-2"></i>Note associated symptoms</li>
                    </ul>

                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Important:</strong> AI diagnosis is for assistance only. Always use clinical judgment.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AI Processing Modal -->
<div class="modal fade" id="aiProcessingModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-5">
                <div class="spinner-border text-primary mb-3" style="width: 4rem; height: 4rem;" role="status">
                    <span class="visually-hidden">Processing...</span>
                </div>
                <h4 class="mb-3">AI Analysis in Progress</h4>
                <p class="text-muted mb-4">Please wait while our multi-agent system analyzes the case...</p>
                
                <div class="progress mb-3" style="height: 30px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" 
                         id="progress-bar"
                         style="width: 10%"
                         aria-valuenow="10" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                        <span id="progress-text">Initializing...</span>
                    </div>
                </div>
                
                <div class="small text-muted" id="progress-stage">
                    <i class="fas fa-robot me-2"></i>Starting AI agents...
                </div>
                
                <div class="alert alert-info mt-4 small mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Processing time:</strong> 30-90 seconds depending on case complexity and server load.
                    <br><small class="text-muted mt-1 d-block">
                        The AI is analyzing medical knowledge, generating diagnoses, and creating treatment plans.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- jQuery (required for AJAX) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
$(document).ready(function() {
    // Load patient history when patient is selected
    $('#load-patient-history').click(function() {
        const patientId = $('#id_patient').val();
        if (!patientId) {
            alert('Please select a patient first.');
            return;
        }

        // Show loading state
        $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Loading...');

        $.ajax({
            url: "{% url 'diagnoses:patient_history_ajax' 0 %}".replace('0', patientId),
            method: 'GET',
            success: function(data) {
                let historyHtml = `
                    <p><strong>Name:</strong> ${data.patient_name}</p>
                    <p><strong>Age:</strong> ${data.age || 'Unknown'}</p>
                    <p><strong>Gender:</strong> ${data.gender}</p>
                    <p><strong>Allergies:</strong> ${data.allergies}</p>
                `;

                if (data.recent_diagnoses && data.recent_diagnoses.length > 0) {
                    historyHtml += '<h6>Recent Diagnoses:</h6><ul>';
                    data.recent_diagnoses.forEach(function(diagnosis) {
                        historyHtml += `<li>${diagnosis.date}: ${diagnosis.diagnosis} (${diagnosis.provider})</li>`;
                    });
                    historyHtml += '</ul>';
                } else {
                    historyHtml += '<p><em>No recent diagnoses on record.</em></p>';
                }

                $('#history-content').html(historyHtml);
                $('#patient-history').slideDown();
                
                // Reset button
                $('#load-patient-history').prop('disabled', false).html('<i class="fas fa-history me-2"></i>Load Patient History');
            },
            error: function(xhr, status, error) {
                console.error('AJAX Error:', status, error);
                console.error('Response:', xhr.responseText);
                
                let errorMsg = 'Error loading patient history';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg += ': ' + xhr.responseJSON.error;
                } else if (xhr.status === 404) {
                    errorMsg += ': Patient history endpoint not found';
                } else if (xhr.status === 500) {
                    errorMsg += ': Server error';
                } else {
                    errorMsg += ': ' + error;
                }
                
                alert(errorMsg);
                
                // Reset button
                $('#load-patient-history').prop('disabled', false).html('<i class="fas fa-history me-2"></i>Load Patient History');
            }
        });
    });

    // Form submission with AI progress modal
    $('#case-form').submit(function(e) {
        // Prepare vital signs data from individual fields
        const vitalSigns = {};
        
        const temperature = $('#temperature').val();
        if (temperature) vitalSigns.temperature = parseFloat(temperature);
        
        const weight = $('#weight').val();
        if (weight) vitalSigns.weight = parseFloat(weight);
        
        const systolic = $('#blood_pressure_systolic').val();
        const diastolic = $('#blood_pressure_diastolic').val();
        if (systolic && diastolic) {
            vitalSigns.blood_pressure = `${systolic}/${diastolic}`;
        }
        
        // Add hidden field with JSON data
        if (!$('input[name="vital_signs"]').length) {
            $('<input>').attr({
                type: 'hidden',
                name: 'vital_signs',
                value: JSON.stringify(vitalSigns)
            }).appendTo('#case-form');
        } else {
            $('input[name="vital_signs"]').val(JSON.stringify(vitalSigns));
        }
        
        // Show AI processing modal with simulated progress
        const modal = new bootstrap.Modal(document.getElementById('aiProcessingModal'));
        modal.show();
        
        // Simulate progress stages
        let progress = 10;
        const stages = [
            { percent: 20, text: '20%', stage: 'Initializing AI agents...' },
            { percent: 35, text: '35%', stage: 'Searching medical knowledge base...' },
            { percent: 50, text: '50%', stage: 'Analyzing symptoms...' },
            { percent: 65, text: '65%', stage: 'Generating differential diagnoses...' },
            { percent: 80, text: '80%', stage: 'Creating treatment plan...' },
            { percent: 95, text: '95%', stage: 'Finalizing results...' }
        ];
        
        let currentStage = 0;
        const progressInterval = setInterval(function() {
            if (currentStage < stages.length) {
                progress = stages[currentStage].percent;
                $('#progress-bar')
                    .css('width', progress + '%')
                    .attr('aria-valuenow', progress)
                    .find('#progress-text').text(stages[currentStage].text);
                $('#progress-stage').html('<i class="fas fa-robot me-2"></i>' + stages[currentStage].stage);
                currentStage++;
            } else {
                clearInterval(progressInterval);
            }
        }, 2000); // Update every 2 seconds
        
        // Disable button
        $('#submit-btn').prop('disabled', true).html(
            '<i class="fas fa-spinner fa-spin me-2"></i>Processing...'
        );
    });

    // Image Upload Functionality
    const imageDropZone = document.getElementById('imageDropZone');
    const imageInput = document.getElementById('symptom_image');
    const imagePreviewContainer = document.getElementById('imagePreviewContainer');
    const imagePreview = document.getElementById('imagePreview');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');

    // Click to upload
    imageDropZone.addEventListener('click', function() {
        imageInput.click();
    });

    // Handle file selection from input
    imageInput.addEventListener('change', function(e) {
        handleImageUpload(e.target.files[0]);
    });

    // Drag and drop events
    imageDropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
        imageDropZone.style.background = '#e7f3ff';
        imageDropZone.style.borderColor = '#0066cc';
    });

    imageDropZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        e.stopPropagation();
        imageDropZone.style.background = 'transparent';
        imageDropZone.style.borderColor = '#007bff';
    });

    imageDropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        imageDropZone.style.background = 'transparent';
        imageDropZone.style.borderColor = '#007bff';
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleImageUpload(files[0]);
        }
    });

    function handleImageUpload(file) {
        // Validate file type
        if (!file.type.startsWith('image/')) {
            alert('Please select a valid image file');
            return;
        }

        // Validate file size (10MB)
        const maxSize = 10 * 1024 * 1024;
        if (file.size > maxSize) {
            alert('File size must be less than 10MB');
            return;
        }

        // Read and display the image
        const reader = new FileReader();
        reader.onload = function(e) {
            imagePreview.src = e.target.result;
            fileName.textContent = file.name;
            fileSize.textContent = (file.size / 1024).toFixed(2) + ' KB';
            imagePreviewContainer.style.display = 'block';
            
            // Update the file input
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            imageInput.files = dataTransfer.files;
        };
        reader.readAsDataURL(file);
    }
});

// Clear Image Upload Function - Outside of ready() so it's accessible from HTML onclick
function clearImageUpload() {
    // Get references to DOM elements
    const imageInput = document.getElementById('symptom_image');
    const imagePreviewContainer = document.getElementById('imagePreviewContainer');
    const imagePreview = document.getElementById('imagePreview');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const imageDropZone = document.getElementById('imageDropZone');
    
    // Clear all image data
    imageInput.value = '';
    imagePreviewContainer.style.display = 'none';
    imagePreview.src = '';
    fileName.textContent = '';
    fileSize.textContent = '';
    
    // Show confirmation message
    alert('Image removed successfully! You can upload a new image if needed.');
    
    // Reset drop zone styling
    imageDropZone.style.background = 'transparent';
    imageDropZone.style.borderColor = '#007bff';
}
</script>
{% endblock %}