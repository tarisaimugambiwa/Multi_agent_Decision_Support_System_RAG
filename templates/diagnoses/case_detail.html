{% extends 'base.html' %}

{% block title %}Case #{{ case.id }} - AI Medical Report{% endblock %}

{% block extra_css %}
<style>
    .report-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
    }
    
    .report-section {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .section-title {
        color: #667eea;
        font-size: 1.3rem;
        font-weight: 600;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 3px solid #667eea;
    }
    
    .section-title i {
        margin-right: 10px;
    }
    
    .diagnosis-card {
        background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
        border-left: 4px solid #1976d2;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 15px;
    }
    
    .primary-diagnosis {
        font-size: 1.4rem;
        font-weight: 700;
        color: #1976d2;
        margin-bottom: 10px;
    }
    
    .confidence-bar {
        height: 30px;
        background: #e0e0e0;
        border-radius: 15px;
        overflow: hidden;
        margin-top: 10px;
    }
    
    .confidence-fill {
        height: 100%;
        background: linear-gradient(90deg, #4caf50 0%, #8bc34a 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        transition: width 1s ease;
    }
    
    .red-flag {
        background: #ffebee;
        border-left: 4px solid #f44336;
        padding: 12px 15px;
        margin-bottom: 10px;
        border-radius: 6px;
        font-weight: 500;
    }
    
    .emergency-condition {
        background: #ff5252;
        color: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        font-weight: 600;
        font-size: 1.1rem;
    }
    
    .differential-item {
        background: #f5f5f5;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        border-left: 3px solid #9c27b0;
    }
    
    .medication-card {
        background: #e8f5e9;
        border-left: 4px solid #4caf50;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 12px;
    }
    
    .action-timeline {
        position: relative;
        padding-left: 40px;
        margin-top: 20px;
    }
    
    .action-timeline::before {
        content: '';
        position: absolute;
        left: 15px;
        top: 0;
        bottom: 0;
        width: 3px;
        background: #667eea;
    }
    
    .action-item {
        position: relative;
        padding: 15px;
        margin-bottom: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }
    
    .action-item::before {
        content: '';
        position: absolute;
        left: -28px;
        top: 20px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #667eea;
        border: 3px solid white;
    }
    
    .priority-badge {
        padding: 8px 16px;
        border-radius: 25px;
        font-weight: 600;
        font-size: 0.95rem;
    }
    
    .priority-CRITICAL { background: #ff5252; color: white; }
    .priority-URGENT { background: #ff9800; color: white; }
    .priority-HIGH { background: #ffc107; color: #212529; }
    .priority-MEDIUM { background: #2196f3; color: white; }
    .priority-LOW { background: #9e9e9e; color: white; }
    
    .knowledge-source {
        background: #fff8e1;
        border-left: 4px solid #ffc107;
        padding: 12px;
        margin-bottom: 10px;
        border-radius: 6px;
        font-size: 0.9rem;
    }
    
    .vital-sign {
        display: inline-block;
        padding: 8px 15px;
        background: #e3f2fd;
        border-radius: 20px;
        margin: 5px;
        font-weight: 500;
    }
    
    .test-badge {
        display: inline-block;
        padding: 6px 12px;
        background: #f3e5f5;
        border: 1px solid #9c27b0;
        border-radius: 15px;
        margin: 5px;
        font-size: 0.9rem;
    }
    
    .print-button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 25px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .print-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    @media print {
        .no-print {
            display: none !important;
        }
        .report-section {
            page-break-inside: avoid;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header -->
    <div class="report-header no-print">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h1 class="mb-2">
                    <i class="fas fa-file-medical me-2"></i>
                    AI Medical Report - Case #{{ case.id }}
                </h1>
                <p class="mb-0 opacity-90">
                    Generated by HealthFlow Multi-Agent Diagnostic System
                </p>
            </div>
            <div class="text-end">
                <button onclick="window.print()" class="btn print-button mb-2">
                    <i class="fas fa-print me-2"></i>Print Report
                </button>
                <br>
                <span class="priority-badge priority-{{ case.priority }}">
                    {{ case.get_priority_display }}
                </span>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Report -->
        <div class="col-lg-8">
            <!-- Patient Information -->
            <div class="report-section">
                <h3 class="section-title">
                    <i class="fas fa-user"></i>Patient Information
                </h3>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Name:</strong> {{ case.patient.full_name }}</p>
                        <p><strong>Age:</strong> {{ case.patient.age|default:"N/A" }} years</p>
                        <p><strong>Gender:</strong> {{ case.patient.get_gender_display }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Phone:</strong> {{ case.patient.phone_number|default:"N/A" }}</p>
                        <p><strong>Allergies:</strong> {{ case.patient.allergies|default:"None reported" }}</p>
                        <p><strong>Case Date:</strong> {{ case.created_at|date:"F d, Y - g:i A" }}</p>
                    </div>
                </div>
                
                {% if case.patient.medical_history %}
                <div class="mt-3">
                    <strong>Medical History:</strong>
                    <p class="text-muted">{{ case.patient.medical_history }}</p>
                </div>
                {% endif %}
            </div>

            <!-- Chief Complaints & Symptoms -->
            <div class="report-section">
                <h3 class="section-title">
                    <i class="fas fa-stethoscope"></i>Chief Complaints & Symptoms
                </h3>
                
                <!-- Symptoms Description -->
                <p class="lead">{{ case.symptoms }}</p>
                
                {% if case.vital_signs %}
                <div class="mt-3">
                    <strong>Vital Signs:</strong><br>
                    {% for key, value in case.vital_signs.items %}
                        <span class="vital-sign">
                            <i class="fas fa-heartbeat me-1"></i>
                            {{ key|title }}: {{ value }}
                        </span>
                    {% endfor %}
                </div>
                {% endif %}
                
                <!-- Symptom Picture (if uploaded) - Below Symptoms -->
                {% if case.symptom_image %}
                <div class="mb-4 mt-4">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-image me-2"></i>Symptom Visual Documentation
                            </h6>
                        </div>
                        <div class="card-body text-center">
                            <img src="data:image/jpeg;base64,{{ case.symptom_image }}" 
                                 alt="Symptom Picture" 
                                 style="max-width: 100%; max-height: 400px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            {% if case.symptom_image_filename %}
                            <p class="text-muted mt-2 mb-0">
                                <i class="fas fa-file-image me-1"></i>
                                <small>Uploaded: {{ case.symptom_image_filename }}</small>
                            </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- AI Diagnosis -->
            {% if ai_diagnosis_data.diagnosis %}
            <div class="report-section">
                <h3 class="section-title">
                    <i class="fas fa-brain"></i>AI-Powered Diagnosis
                </h3>
                
                <!-- Primary Diagnosis with Explanation -->
                <div class="diagnosis-card">
                    <div class="primary-diagnosis">
                        {{ ai_diagnosis_data.diagnosis.primary_diagnosis }}
                    </div>
                    
                    {% if ai_diagnosis_data.diagnosis.explanation %}
                    <div class="mt-3">
                        <strong><i class="fas fa-info-circle me-2"></i>What This Means:</strong>
                        <p class="text-muted">{{ ai_diagnosis_data.diagnosis.explanation }}</p>
                    </div>
                    {% endif %}
                    
                    <div class="mt-3">
                        <strong>AI Confidence Level:</strong>
                        <div class="confidence-bar">
                            <div class="confidence-fill" data-confidence="{{ ai_diagnosis_data.diagnosis.confidence|floatformat:0 }}">
                                {{ ai_diagnosis_data.diagnosis.confidence|floatformat:0 }}% Confidence
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Emergency Conditions -->
                {% if ai_diagnosis_data.diagnosis.emergency_conditions %}
                <div class="mt-3">
                    <h5 class="text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>⚠️ Emergency Alert
                    </h5>
                    {% for condition in ai_diagnosis_data.diagnosis.emergency_conditions %}
                    <div class="emergency-condition">
                        <i class="fas fa-bolt me-2"></i>{{ condition }}
                    </div>
                    {% endfor %}
                    <p class="text-danger mt-2"><strong>Action Required:</strong> Immediate medical attention needed!</p>
                </div>
                {% endif %}

                <!-- Red Flags -->
                {% if ai_diagnosis_data.diagnosis.red_flags %}
                <div class="mt-3">
                    <h5 class="text-warning">
                        <i class="fas fa-flag me-2"></i>Important Warning Signs
                    </h5>
                    {% for flag in ai_diagnosis_data.diagnosis.red_flags %}
                    <div class="red-flag">
                        <i class="fas fa-exclamation-circle me-2"></i>{{ flag.category }}: {{ flag.symptom }}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Recommended Tests - Only for Doctors -->
                {% if ai_diagnosis_data.diagnosis.recommended_tests and user.role == 'DOCTOR' %}
                <div class="mt-4">
                    <h5><i class="fas fa-vial me-2"></i>Recommended Diagnostic Tests</h5>
                    {% for test in ai_diagnosis_data.diagnosis.recommended_tests %}
                    <span class="test-badge">{{ test }}</span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- Doctor's Comments on AI Diagnosis -->
            {% if user.role == 'DOCTOR' %}
            <div class="report-section" style="background: linear-gradient(135deg, #e0f7ff 0%, #f0e6ff 100%); border-left: 5px solid #00bcd4;">
                <h3 class="section-title" style="color: #00796b;">
                    <i class="fas fa-stethoscope" style="color: #00bcd4;"></i>Doctor's Assessment of AI Diagnosis
                </h3>
                
                {% if case.diagnosis_comments %}
                <!-- Display existing diagnosis comments -->
                <div class="alert alert-info" style="background: linear-gradient(135deg, #b3e5fc 0%, #c8e6c9 100%); border-left: 4px solid #00796b;" id="diagnosis-comments-display">
                    <div class="d-flex justify-content-between align-items-start">
                        <div style="flex: 1;">
                            <strong><i class="fas fa-comment me-2"></i>Your Assessment:</strong>
                            <p class="mt-2 mb-1">{{ case.diagnosis_comments }}</p>
                            <small class="text-muted">
                                <i class="fas fa-calendar me-1"></i>
                                Last updated: {{ case.diagnosis_comments_date|date:"M d, Y - H:i" }}
                            </small>
                        </div>
                        <button class="btn btn-sm btn-outline-primary ms-3" 
                                onclick="showEditDiagnosisComments()"
                                style="min-width: 90px;">
                            <i class="fas fa-edit me-1"></i>Edit
                        </button>
                    </div>
                </div>
                {% else %}
                <!-- Show input form for new diagnosis comments -->
                <div class="alert alert-warning" style="background: linear-gradient(135deg, #ffe0b2 0%, #fff9c4 100%); border-left: 4px solid #ff6f00;">
                    <p class="text-muted mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        Review the AI diagnosis above and add your professional assessment of its accuracy and recommendations.
                    </p>
                </div>
                {% endif %}
                
                <div id="diagnosis-comments-form">
                    <textarea id="diagnosis-comments-textarea" 
                              class="form-control mb-2" 
                              rows="4" 
                              placeholder="Enter your assessment of the AI diagnosis, any concerns, or additional observations..."
                              style="resize: vertical; border: 2px solid #00bcd4;">{% if case.diagnosis_comments %}{{ case.diagnosis_comments }}{% endif %}</textarea>
                    
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" onclick="saveDiagnosisComments()" style="background-color: #00796b; border-color: #00796b;">
                            <i class="fas fa-save me-2"></i>Save Assessment
                        </button>
                        <button class="btn btn-secondary" id="cancel-diagnosis-btn" 
                                onclick="cancelDiagnosisComments()">
                            <i class="fas fa-times me-2"></i>Cancel
                        </button>
                    </div>
                </div>
            </div>
            {% elif user.role == 'NURSE' and case.diagnosis_comments %}
            <!-- Nurses see diagnosis comments only after doctor writes them -->
            <div class="report-section" style="background: linear-gradient(135deg, #e0f7ff 0%, #f0e6ff 100%); border-left: 5px solid #00bcd4;">
                <h3 class="section-title" style="color: #00796b;">
                    <i class="fas fa-stethoscope" style="color: #00bcd4;"></i>Doctor's Assessment of AI Diagnosis
                </h3>
                <div class="alert alert-info" style="background: linear-gradient(135deg, #b3e5fc 0%, #c8e6c9 100%); border-left: 4px solid #00796b;">
                    <strong><i class="fas fa-comment me-2"></i>Doctor's Assessment:</strong>
                    <p class="mt-2 mb-1">{{ case.diagnosis_comments }}</p>
                    <small class="text-muted">
                        <i class="fas fa-calendar me-1"></i>
                        Provided: {{ case.diagnosis_comments_date|date:"M d, Y - H:i" }}
                    </small>
                </div>
            </div>
            {% endif %}
            
            <!-- Treatment Plan -->
            {% if ai_diagnosis_data.treatment %}
            <div class="report-section">
                <h3 class="section-title">
                    <i class="fas fa-notes-medical"></i>Treatment Plan & Recommendations
                    {% if ai_diagnosis_data.treatment.knowledge_base_used %}
                    <span class="badge bg-success ms-2" style="font-size: 0.7rem;">
                        <i class="fas fa-database"></i> Evidence-Based from Knowledge Base
                    </span>
                    {% endif %}
                </h3>

                <!-- Evidence Sources Badge -->
                {% if ai_diagnosis_data.treatment.evidence_sources %}
                <div class="alert alert-info mb-3" style="background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); border-left: 4px solid #2196F3;">
                    <i class="fas fa-book-medical me-2"></i>
                    <strong>Treatment guidelines sourced from:</strong>
                    <ul class="mb-0 mt-2">
                        {% for source in ai_diagnosis_data.treatment.evidence_sources %}
                        <li>{{ source }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                <!-- Action Plan Timeline -->
                {% if ai_diagnosis_data.treatment.immediate_actions or ai_diagnosis_data.treatment.short_term_actions or ai_diagnosis_data.treatment.follow_up_actions %}
                <div class="action-timeline">
                    {% if ai_diagnosis_data.treatment.immediate_actions %}
                    <h5><i class="fas fa-exclamation-circle text-danger me-2"></i>Immediate Actions (0-15 minutes)</h5>
                    {% for action in ai_diagnosis_data.treatment.immediate_actions %}
                    <div class="action-item">
                        <i class="fas fa-bolt text-danger me-2"></i>
                        <strong>{{ action }}</strong>
                    </div>
                    {% endfor %}
                    {% endif %}

                    {% if ai_diagnosis_data.treatment.short_term_actions %}
                    <h5 class="mt-4"><i class="fas fa-clock text-warning me-2"></i>Short-term Actions (Within 1-4 hours)</h5>
                    {% for action in ai_diagnosis_data.treatment.short_term_actions %}
                    <div class="action-item">
                        <i class="fas fa-check-circle text-warning me-2"></i>
                        {{ action }}
                    </div>
                    {% endfor %}
                    {% endif %}

                    {% if ai_diagnosis_data.treatment.follow_up_actions %}
                    <h5 class="mt-4"><i class="fas fa-calendar-check text-info me-2"></i>Follow-up Actions (3-7 days)</h5>
                    {% for action in ai_diagnosis_data.treatment.follow_up_actions %}
                    <div class="action-item">
                        <i class="fas fa-arrow-right text-info me-2"></i>
                        {{ action }}
                    </div>
                    {% endfor %}
                    {% endif %}
                </div>
                {% endif %}

                <!-- Medications -->
                {% if ai_diagnosis_data.treatment.medications %}
                <div class="mt-4">
                    <h5><i class="fas fa-pills me-2"></i>Medication Recommendations
                        {% if ai_diagnosis_data.treatment.medications.knowledge_base_used %}
                        <span class="badge bg-primary ms-2" style="font-size: 0.65rem;">
                            <i class="fas fa-book-medical"></i> From Medical Guidelines
                        </span>
                        {% endif %}
                    </h5>

                    <!-- Medication Evidence Sources -->
                    {% if ai_diagnosis_data.treatment.medications.evidence_sources %}
                    <div class="alert alert-light border-start border-primary border-3 mb-3" style="font-size: 0.9rem;">
                        <i class="fas fa-file-medical-alt text-primary me-2"></i>
                        <strong>Referenced from:</strong> 
                        {% for source in ai_diagnosis_data.treatment.medications.evidence_sources %}
                            {% if not forloop.last %}
                                {{ source }}, 
                            {% else %}
                                {{ source }}
                            {% endif %}
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    {% if ai_diagnosis_data.treatment.medications.primary_medications %}
                    <h6 class="mt-3"><i class="fas fa-star text-warning me-2"></i>Primary Medications:</h6>
                    {% for med in ai_diagnosis_data.treatment.medications.primary_medications %}
                    <div class="medication-card">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="w-100">
                                <strong class="text-success">
                                    <i class="fas fa-prescription-bottle me-2"></i>
                                    {{ med.name }}
                                </strong>
                                <p class="mb-1 mt-2">
                                    <i class="fas fa-tablets me-1"></i><strong>Dosage:</strong> {{ med.dosage }}<br>
                                    <i class="fas fa-calendar me-1"></i><strong>Duration:</strong> {{ med.duration }}<br>
                                    <i class="fas fa-info-circle me-1"></i><strong>Instructions:</strong> {{ med.instructions }}
                                </p>
                                {% if med.source %}
                                <p class="text-muted mb-1" style="font-size: 0.85rem;">
                                    <i class="fas fa-book me-1"></i><em>Source: {{ med.source }}</em>
                                </p>
                                {% endif %}
                                {% if med.contraindications %}
                                <p class="text-danger mb-0">
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    <strong>Warning:</strong> {{ med.contraindications }}
                                </p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% endif %}
                    
                    {% if ai_diagnosis_data.treatment.medications.alternative_medications %}
                    <h6 class="mt-4"><i class="fas fa-exchange-alt text-info me-2"></i>Alternative Medications (if primary not available):</h6>
                    {% for med in ai_diagnosis_data.treatment.medications.alternative_medications %}
                    <div class="medication-card" style="background: #e1f5fe;">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="w-100">
                                <strong class="text-info">
                                    <i class="fas fa-prescription-bottle-alt me-2"></i>
                                    {{ med.name }}
                                </strong>
                                <p class="mb-1 mt-2">
                                    <i class="fas fa-tablets me-1"></i><strong>Dosage:</strong> {{ med.dosage }}<br>
                                    <i class="fas fa-calendar me-1"></i><strong>Duration:</strong> {{ med.duration }}<br>
                                    <i class="fas fa-info-circle me-1"></i><strong>Instructions:</strong> {{ med.instructions }}
                                </p>
                                {% if med.source %}
                                <p class="text-muted mb-1" style="font-size: 0.85rem;">
                                    <i class="fas fa-book me-1"></i><em>Source: {{ med.source }}</em>
                                </p>
                                {% endif %}
                                {% if med.contraindications %}
                                <p class="text-danger mb-0">
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    <strong>Warning:</strong> {{ med.contraindications %}
                                </p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% endif %}
                    
                    <!-- Show message if no medications available -->
                    {% if not ai_diagnosis_data.treatment.medications.primary_medications and not ai_diagnosis_data.treatment.medications.alternative_medications %}
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Note:</strong> Medication recommendations are being generated from medical knowledge base. 
                        Please consult with a healthcare provider for specific medication prescriptions based on patient condition and history.
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <div class="mt-4">
                    <h5><i class="fas fa-pills me-2"></i>Medication Recommendations</h5>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Medication data not available. Please regenerate the diagnosis or consult with a healthcare provider.
                    </div>
                </div>
                {% endif %}

                <!-- Treatment Warnings -->
                {% if ai_diagnosis_data.treatment.warnings %}
                <div class="mt-4">
                    <h5><i class="fas fa-exclamation-triangle text-danger me-2"></i>Important Warnings</h5>
                    {% for warning in ai_diagnosis_data.treatment.warnings %}
                    <div class="red-flag">
                        <i class="fas fa-shield-alt me-2"></i>{{ warning }}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Success Criteria -->
                {% if ai_diagnosis_data.treatment.success_criteria %}
                <div class="mt-4">
                    <h5><i class="fas fa-clipboard-check text-success me-2"></i>Treatment Success Indicators</h5>
                    <div class="alert alert-success" style="background: #e8f5e9; border-left: 4px solid #4caf50;">
                        <p class="mb-0"><strong>Look for these signs of improvement:</strong></p>
                        <ul class="mt-2 mb-0">
                            {% for criteria in ai_diagnosis_data.treatment.success_criteria %}
                            <li>{{ criteria }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                {% endif %}

                <!-- First Aid (Emergency Cases) -->
                {% if ai_diagnosis_data.treatment.first_aid %}
                <div class="mt-4">
                    <div class="emergency-condition">
                        <i class="fas fa-first-aid me-2"></i>
                        <strong>Emergency First Aid Protocol</strong>
                    </div>
                    {% for step in ai_diagnosis_data.treatment.first_aid %}
                    <div class="action-item mt-2">
                        {{ step }}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Doctor's Comments on Treatment Plan -->
            {% if user.role == 'DOCTOR' %}
            <div class="report-section" style="background: linear-gradient(135deg, #fff8e1 0%, #ffe082 100%); border-left: 5px solid #fbc02d;">
                <h3 class="section-title" style="color: #f57f17; border-bottom-color: #fbc02d;">
                    <i class="fas fa-comment-medical me-2"></i>Doctor's Comments on Treatment Plan
                </h3>
                
                {% if case.treatment_comments %}
                <div class="alert alert-success" style="background: #e8f5e9; border-left: 4px solid #4caf50; margin-bottom: 15px;">
                    <p class="mb-0">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <strong>Comments added on {{ case.treatment_comments_date|date:"M d, Y g:i A" }}</strong>
                    </p>
                </div>
                <div style="background: white; padding: 15px; border-radius: 6px; border-left: 3px solid #4caf50; margin-bottom: 15px;">
                    {{ case.treatment_comments|linebreaks }}
                </div>
                <button type="button" class="btn btn-sm btn-warning" onclick="showEditTreatmentComments()">
                    <i class="fas fa-edit me-1"></i>Edit Comments
                </button>
                {% else %}
                <div style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                    <p class="text-muted mb-3">
                        <i class="fas fa-pencil-alt text-info me-2"></i>
                        Add your clinical comments, modifications, or concerns about the treatment plan and recommendations.
                    </p>
                    <textarea id="treatmentCommentsText" class="form-control" rows="5" placeholder="Enter your comments on the treatment plan..."></textarea>
                    <div class="mt-3">
                        <button type="button" class="btn btn-sm btn-primary" onclick="saveTreatmentComments()">
                            <i class="fas fa-save me-1"></i>Save Comments
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="cancelTreatmentComments()">
                            <i class="fas fa-times me-1"></i>Cancel
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Doctor's Comments Visibility for Nurses - Only show AFTER comments are written -->
            {% if user.role == 'NURSE' and case.treatment_comments %}
            <div class="report-section" style="background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); border-left: 5px solid #2196F3;">
                <h3 class="section-title" style="color: #1976d2; border-bottom-color: #2196F3;">
                    <i class="fas fa-stethoscope me-2"></i>Doctor's Clinical Review
                </h3>
                
                <div class="alert alert-info" style="background: #e3f2fd; border-left: 4px solid #2196F3; margin-bottom: 15px;">
                    <p class="mb-0">
                        <i class="fas fa-check-circle text-info me-2"></i>
                        <strong>Doctor's review received on {{ case.treatment_comments_date|date:"M d, Y g:i A" }}</strong>
                    </p>
                </div>
                <div style="background: white; padding: 15px; border-radius: 6px; border-left: 3px solid #2196F3;">
                    {{ case.treatment_comments|linebreaks }}
                </div>
            </div>
            {% elif user.role == 'NURSE' %}
            <div class="report-section" style="background: linear-gradient(135deg, #fce4ec 0%, #f8bbd0 100%); border-left: 5px solid #e91e63;">
                <h3 class="section-title" style="color: #c2185b; border-bottom-color: #e91e63;">
                    <i class="fas fa-hourglass-half me-2"></i>Awaiting Doctor's Review
                </h3>
                
                <div class="alert alert-warning" style="background: #fff3e0; border-left: 4px solid #ff9800;">
                    <i class="fas fa-clock me-2"></i>
                    <strong>Waiting for doctor's clinical review and comments on this treatment plan.</strong>
                    <p class="mt-2 mb-0 text-muted">Once the doctor reviews this case and adds their clinical comments, they will appear here.</p>
                </div>
            </div>
            {% endif %}

            <!-- Knowledge Base References - Only visible to Doctors and Experts -->
            {% if ai_diagnosis_data.retriever.sources and user.role != 'PATIENT' and user.role != 'NURSE' %}
            <div class="report-section">
                <h3 class="section-title">
                    <i class="fas fa-book-medical"></i>Medical Knowledge References
                </h3>
                <p class="text-muted">
                    This diagnosis was informed by {{ ai_diagnosis_data.retriever.total_documents }} 
                    medical documents from the knowledge base:
                </p>
                {% for source in ai_diagnosis_data.retriever.sources|slice:":5" %}
                <div class="knowledge-source">
                    <i class="fas fa-file-pdf me-2"></i>
                    <strong>{{ source }}</strong>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Case Status -->
            <div class="report-section">
                <h5 class="section-title">
                    <i class="fas fa-info-circle"></i>Case Status
                </h5>
                <p><strong>Status:</strong> <span class="badge bg-info">{{ case.get_status_display }}</span></p>
                <p><strong>Priority:</strong> <span class="priority-badge priority-{{ case.priority }}">{{ case.get_priority_display }}</span></p>
                <p><strong>Nurse:</strong> {{ case.nurse.get_full_name|default:case.nurse.username }}</p>
                {% if case.doctor %}
                <p><strong>Doctor:</strong> {{ case.doctor.get_full_name|default:case.doctor.username }}</p>
                {% endif %}
                <p><strong>Created:</strong> {{ case.created_at|date:"M d, Y g:i A" }}</p>
                <p><strong>Last Updated:</strong> {{ case.updated_at|date:"M d, Y g:i A" }}</p>
            </div>

            <!-- Routing Decision (Doctor Only) -->
            {% if ai_diagnosis_data.routing and user.role == 'DOCTOR' %}
            <div class="report-section">
                <h5 class="section-title">
                    <i class="fas fa-route"></i>AI Routing
                </h5>
                <p><strong>Urgency Level:</strong> <span class="text-uppercase text-danger">{{ ai_diagnosis_data.routing.urgency_level }}</span></p>
                <p><strong>Urgency Score:</strong> {{ ai_diagnosis_data.routing.urgency_score }}/100</p>
                <p><strong>Reason:</strong> {{ ai_diagnosis_data.routing.routing_reason }}</p>
                {% if ai_diagnosis_data.routing.needs_doctor_review %}
                <div class="alert alert-warning">
                    <i class="fas fa-user-md me-2"></i>
                    <strong>Doctor Review Required</strong>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Actions -->
            <div class="report-section no-print">
                <h5 class="section-title">
                    <i class="fas fa-tasks"></i>Actions
                </h5>
                <div class="d-grid gap-2">
                    {% if user.role == 'PATIENT' %}
                        <!-- Patients only need the print action -->
                        <button onclick="window.print()" class="btn btn-success">
                            <i class="fas fa-print me-2"></i>Print Report
                        </button>
                    {% else %}
                        <a href="{% url 'diagnoses:case_list' %}" class="btn btn-outline-primary">
                            <i class="fas fa-arrow-left me-2"></i>Back to Cases
                        </a>
                        {% if user.role == 'DOCTOR' %}
                        <a href="{% url 'diagnoses:case_review' case.id %}" class="btn btn-primary">
                            <i class="fas fa-clipboard-check me-2"></i>Review Case
                        </a>
                        {% endif %}
                        <button onclick="regenerateDiagnosis()" class="btn btn-warning" id="regenerate-btn">
                            <i class="fas fa-sync-alt me-2"></i>Regenerate Diagnosis
                        </button>
                        <button onclick="window.print()" class="btn btn-success">
                            <i class="fas fa-print me-2"></i>Print Report
                        </button>
                    {% endif %}
                </div>
            </div>

            <!-- Doctor's Comments Section -->
            {% if user.role == 'DOCTOR' %}
            <div class="report-section">
                <h5 class="section-title">
                    <i class="fas fa-comments-medical"></i>Doctor's Review & Comments
                </h5>
                
                <!-- Existing Doctor Review (if any) -->
                {% if case.doctor_review %}
                <div class="alert alert-info mb-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-2"><i class="fas fa-user-md me-2"></i>Previous Review</h6>
                            <p class="mb-1" style="white-space: pre-wrap;">{{ case.doctor_review }}</p>
                            {% if case.reviewed_by %}
                            <small class="text-muted">
                                <i class="fas fa-user me-1"></i>{{ case.reviewed_by.get_full_name }}
                                {% if case.reviewed_at %}
                                | <i class="fas fa-clock me-1"></i>{{ case.reviewed_at|date:"M d, Y g:i A" }}
                                {% endif %}
                            </small>
                            {% endif %}
                        </div>
                        <span class="badge bg-primary">
                            {% if case.doctor_decision == 'approved' %}
                                <i class="fas fa-check"></i> Approved
                            {% elif case.doctor_decision == 'modified' %}
                                <i class="fas fa-edit"></i> Modified
                            {% elif case.doctor_decision == 'rejected' %}
                                <i class="fas fa-times"></i> Rejected
                            {% else %}
                                <i class="fas fa-eye"></i> Reviewed
                            {% endif %}
                        </span>
                    </div>
                </div>
                {% endif %}

                <!-- Add/Update Comment Form -->
                <form id="doctorCommentForm" onsubmit="submitDoctorComment(event)">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="doctorComment" class="form-label">
                            <strong>{% if case.doctor_review %}Update Review{% else %}Add Review{% endif %}</strong>
                        </label>
                        <textarea 
                            class="form-control" 
                            id="doctorComment" 
                            name="doctor_review" 
                            rows="5" 
                            placeholder="Enter your review, comments, or recommendations here...">{{ case.doctor_review }}</textarea>
                        <div class="form-text">
                            Share your expert opinion on the AI diagnosis, suggest modifications, or provide additional guidance.
                        </div>
                    </div>

                    <!-- Decision Selection -->
                    <div class="mb-3">
                        <label class="form-label"><strong>Your Decision:</strong></label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="doctor_decision" id="decision_approved" value="approved" {% if case.doctor_decision == 'approved' %}checked{% endif %}>
                            <label class="btn btn-outline-success" for="decision_approved">
                                <i class="fas fa-check me-1"></i>Approve AI Diagnosis
                            </label>

                            <input type="radio" class="btn-check" name="doctor_decision" id="decision_modified" value="modified" {% if case.doctor_decision == 'modified' %}checked{% endif %}>
                            <label class="btn btn-outline-warning" for="decision_modified">
                                <i class="fas fa-edit me-1"></i>Needs Modification
                            </label>

                            <input type="radio" class="btn-check" name="doctor_decision" id="decision_rejected" value="rejected" {% if case.doctor_decision == 'rejected' %}checked{% endif %}>
                            <label class="btn btn-outline-danger" for="decision_rejected">
                                <i class="fas fa-times me-1"></i>Reject & Revise
                            </label>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary w-100" id="submitCommentBtn">
                        <i class="fas fa-save me-2"></i>{% if case.doctor_review %}Update Review{% else %}Submit Review{% endif %}
                    </button>
                </form>
            </div>
            {% elif user.role == 'NURSE' and case.doctor_review %}
            <!-- Nurses can view doctor's comments but not edit -->
            <div class="report-section">
                <h5 class="section-title">
                    <i class="fas fa-comments-medical"></i>Doctor's Review
                </h5>
                <div class="alert alert-info">
                    <h6 class="mb-2"><i class="fas fa-user-md me-2"></i>Doctor's Comments</h6>
                    <p class="mb-2" style="white-space: pre-wrap;">{{ case.doctor_review }}</p>
                    {% if case.reviewed_by %}
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <i class="fas fa-user me-1"></i>{{ case.reviewed_by.get_full_name }}
                            {% if case.reviewed_at %}
                            | <i class="fas fa-clock me-1"></i>{{ case.reviewed_at|date:"M d, Y g:i A" }}
                            {% endif %}
                        </small>
                        <span class="badge bg-primary">
                            {% if case.doctor_decision == 'approved' %}
                                <i class="fas fa-check"></i> Approved
                            {% elif case.doctor_decision == 'modified' %}
                                <i class="fas fa-edit"></i> Needs Modification
                            {% elif case.doctor_decision == 'rejected' %}
                                <i class="fas fa-times"></i> Rejected
                            {% endif %}
                        </span>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- AI System Info -->
            <div class="report-section">
                <h5 class="section-title">
                    <i class="fas fa-robot"></i>AI System Info
                </h5>
                <p class="small text-muted">
                    <strong>System:</strong> {{ ai_diagnosis_data.multi_agent_system|default:"HealthFlow DMS v1.0" }}<br>
                    <strong>Generated:</strong> {{ ai_diagnosis_data.timestamp|slice:":19"|default:case.created_at|date:"Y-m-d H:i" }}<br>
                    <strong>Agents Used:</strong> Coordinator, Retriever, Diagnosis, Treatment
                </p>
            </div>
        </div>
    </div>
</div>

<script>
// Animate confidence bar on load
document.addEventListener('DOMContentLoaded', function() {
    const confidenceFill = document.querySelector('.confidence-fill');
    if (confidenceFill) {
        const targetWidth = confidenceFill.getAttribute('data-confidence') + '%';
        confidenceFill.style.width = '0%';
        setTimeout(() => {
            confidenceFill.style.width = targetWidth;
        }, 100);
    }
});

// Regenerate diagnosis function
async function regenerateDiagnosis() {
    const btn = document.getElementById('regenerate-btn');
    const originalText = btn.innerHTML;
    
    // Confirm action
    if (!confirm('Are you sure you want to regenerate the AI diagnosis? This will replace the current diagnosis with a new analysis.')) {
        return;
    }
    
    // Disable button and show loading state
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Regenerating...';
    
    try {
        const response = await fetch(`/diagnoses/api/regenerate-diagnosis/{{ case.id }}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            // Show success message
            alert('Diagnosis regenerated successfully! The page will reload to show the updated diagnosis.');
            // Reload page to show new diagnosis
            window.location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to regenerate diagnosis'));
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    } catch (error) {
        console.error('Error regenerating diagnosis:', error);
        alert('An error occurred while regenerating the diagnosis. Please try again.');
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// Submit doctor's comment function
async function submitDoctorComment(event) {
    event.preventDefault();
    
    const form = document.getElementById('doctorCommentForm');
    const btn = document.getElementById('submitCommentBtn');
    const originalText = btn.innerHTML;
    
    const comment = document.getElementById('doctorComment').value.trim();
    const decision = document.querySelector('input[name="doctor_decision"]:checked')?.value;
    
    if (!comment) {
        alert('Please enter your review comments before submitting.');
        return;
    }
    
    if (!decision) {
        alert('Please select a decision (Approve, Modify, or Reject) before submitting.');
        return;
    }
    
    // Disable button and show loading state
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Submitting...';
    
    try {
        const response = await fetch(`/diagnoses/api/doctor-review/{{ case.id }}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                doctor_review: comment,
                doctor_decision: decision
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            alert('Review submitted successfully!');
            window.location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to submit review'));
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    } catch (error) {
        console.error('Error submitting review:', error);
        alert('An error occurred while submitting your review. Please try again.');
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// Treatment Comments Functions
function saveTreatmentComments() {
    const commentsText = document.getElementById('treatmentCommentsText').value.trim();
    
    if (!commentsText) {
        alert('Please enter your comments before saving.');
        return;
    }
    
    const caseId = '{{ case.id }}';
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const btn = event.target;
    const originalText = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';
    
    fetch('/diagnoses/api/treatment-comments/' + caseId + '/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            comments: commentsText
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Comments saved successfully!');
            window.location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to save comments'));
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while saving comments.');
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
}

function showEditTreatmentComments() {
    const commentsDiv = document.querySelector('div[style*="border-left: 3px solid #4caf50"]');
    if (commentsDiv) {
        const currentText = commentsDiv.innerText;
        commentsDiv.innerHTML = '<textarea id="treatmentCommentsText" class="form-control" rows="5" style="border: 2px solid #fbc02d;">' + currentText + '</textarea><div class="mt-3"><button type="button" class="btn btn-sm btn-primary" onclick="saveTreatmentComments()"><i class="fas fa-save me-1"></i>Save Comments</button><button type="button" class="btn btn-sm btn-outline-secondary" onclick="window.location.reload()"><i class="fas fa-times me-1"></i>Cancel</button></div>';
    }
}

function cancelTreatmentComments() {
    const textarea = document.getElementById('treatmentCommentsText');
    if (textarea && textarea.parentElement) {
        textarea.parentElement.innerHTML = '';
    }
}

// Diagnosis Comments Functions
function saveDiagnosisComments() {
    const commentsText = document.getElementById('diagnosis-comments-textarea').value.trim();
    
    if (!commentsText) {
        alert('Please enter your assessment before saving.');
        return;
    }
    
    const caseId = '{{ case.id }}';
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const btn = event.target;
    const originalText = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';
    
    fetch('/diagnoses/api/diagnosis-comments/' + caseId + '/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            comments: commentsText
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Assessment saved successfully!');
            window.location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to save assessment'));
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while saving assessment.');
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
}

function showEditDiagnosisComments() {
    const displayDiv = document.getElementById('diagnosis-comments-display');
    const formDiv = document.getElementById('diagnosis-comments-form');
    
    if (displayDiv && formDiv) {
        displayDiv.style.display = 'none';
        formDiv.style.display = 'block';
        document.getElementById('cancel-diagnosis-btn').style.display = 'inline-block';
        document.getElementById('diagnosis-comments-textarea').focus();
    }
}

function cancelDiagnosisComments() {
    const displayDiv = document.getElementById('diagnosis-comments-display');
    const formDiv = document.getElementById('diagnosis-comments-form');
    
    if (displayDiv && formDiv) {
        if (displayDiv.innerHTML.trim()) {
            formDiv.style.display = 'none';
            displayDiv.style.display = 'block';
        }
    }
}

// Initialize diagnosis comments form visibility on page load
document.addEventListener('DOMContentLoaded', function() {
    const displayDiv = document.getElementById('diagnosis-comments-display');
    const formDiv = document.getElementById('diagnosis-comments-form');
    
    if (displayDiv && formDiv) {
        if (displayDiv.innerHTML.trim()) {
            formDiv.style.display = 'none';
        } else {
            formDiv.style.display = 'block';
        }
    }
});
</script>
{% endblock %}

