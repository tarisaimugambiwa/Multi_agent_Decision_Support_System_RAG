{% extends 'base.html' %}

{% block title %}Case #{{ case.id }} - AI Medical Report{% endblock %}

{% block extra_css %}
<style>
    .report-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
    }
    
    .report-section {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .section-title {
        color: #667eea;
        font-size: 1.3rem;
        font-weight: 600;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 3px solid #667eea;
    }
    
    .section-title i {
        margin-right: 10px;
    }
    
    .diagnosis-card {
        background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
        border-left: 4px solid #1976d2;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 15px;
    }
    
    .primary-diagnosis {
        font-size: 1.4rem;
        font-weight: 700;
        color: #1976d2;
        margin-bottom: 10px;
    }
    
    .confidence-bar {
        height: 30px;
        background: #e0e0e0;
        border-radius: 15px;
        overflow: hidden;
        margin-top: 10px;
    }
    
    .confidence-fill {
        height: 100%;
        background: linear-gradient(90deg, #4caf50 0%, #8bc34a 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        transition: width 1s ease;
    }
    
    .red-flag {
        background: #ffebee;
        border-left: 4px solid #f44336;
        padding: 12px 15px;
        margin-bottom: 10px;
        border-radius: 6px;
        font-weight: 500;
    }
    
    .emergency-condition {
        background: #ff5252;
        color: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        font-weight: 600;
        font-size: 1.1rem;
    }
    
    .differential-item {
        background: #f5f5f5;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        border-left: 3px solid #9c27b0;
    }
    
    .medication-card {
        background: #e8f5e9;
        border-left: 4px solid #4caf50;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 12px;
    }
    
    .action-timeline {
        position: relative;
        padding-left: 40px;
        margin-top: 20px;
    }
    
    .action-timeline::before {
        content: '';
        position: absolute;
        left: 15px;
        top: 0;
        bottom: 0;
        width: 3px;
        background: #667eea;
    }
    
    .action-item {
        position: relative;
        padding: 15px;
        margin-bottom: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }
    
    .action-item::before {
        content: '';
        position: absolute;
        left: -28px;
        top: 20px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #667eea;
        border: 3px solid white;
    }
    
    .priority-badge {
        padding: 8px 16px;
        border-radius: 25px;
        font-weight: 600;
        font-size: 0.95rem;
    }
    
    .priority-CRITICAL { background: #ff5252; color: white; }
    .priority-URGENT { background: #ff9800; color: white; }
    .priority-HIGH { background: #ffc107; color: #212529; }
    .priority-MEDIUM { background: #2196f3; color: white; }
    .priority-LOW { background: #9e9e9e; color: white; }
    
    .knowledge-source {
        background: #fff8e1;
        border-left: 4px solid #ffc107;
        padding: 12px;
        margin-bottom: 10px;
        border-radius: 6px;
        font-size: 0.9rem;
    }
    
    .vital-sign {
        display: inline-block;
        padding: 8px 15px;
        background: #e3f2fd;
        border-radius: 20px;
        margin: 5px;
        font-weight: 500;
    }
    
    .test-badge {
        display: inline-block;
        padding: 6px 12px;
        background: #f3e5f5;
        border: 1px solid #9c27b0;
        border-radius: 15px;
        margin: 5px;
        font-size: 0.9rem;
    }
    
    .print-button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 25px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .print-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    @media print {
        .no-print {
            display: none !important;
        }
        .report-section {
            page-break-inside: avoid;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header -->
    <div class="report-header no-print">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h1 class="mb-2">
                    <i class="fas fa-file-medical me-2"></i>
                    AI Medical Report - Case #{{ case.id }}
                </h1>
                <p class="mb-0 opacity-90">
                    Generated by HealthFlow Multi-Agent Diagnostic System
                </p>
            </div>
            <div class="text-end">
                <button onclick="window.print()" class="btn print-button mb-2">
                    <i class="fas fa-print me-2"></i>Print Report
                </button>
                <br>
                <span class="priority-badge priority-{{ case.priority }}">
                    {{ case.get_priority_display }}
                </span>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Report -->
        <div class="col-lg-8">
            <!-- Patient Information -->
            <div class="report-section">
                <h3 class="section-title">
                    <i class="fas fa-user"></i>Patient Information
                </h3>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Name:</strong> {{ case.patient.full_name }}</p>
                        <p><strong>Age:</strong> {{ case.patient.age|default:"N/A" }} years</p>
                        <p><strong>Gender:</strong> {{ case.patient.get_gender_display }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Phone:</strong> {{ case.patient.phone_number|default:"N/A" }}</p>
                        <p><strong>Allergies:</strong> {{ case.patient.allergies|default:"None reported" }}</p>
                        <p><strong>Case Date:</strong> {{ case.created_at|date:"F d, Y - g:i A" }}</p>
                    </div>
                </div>
                
                {% if case.patient.medical_history %}
                <div class="mt-3">
                    <strong>Medical History:</strong>
                    <p class="text-muted">{{ case.patient.medical_history }}</p>
                </div>
                {% endif %}
            </div>

            <!-- Chief Complaints & Symptoms -->
            <div class="report-section">
                <h3 class="section-title">
                    <i class="fas fa-stethoscope"></i>Chief Complaints & Symptoms
                </h3>
                <p class="lead">{{ case.symptoms }}</p>
                
                {% if case.vital_signs %}
                <div class="mt-3">
                    <strong>Vital Signs:</strong><br>
                    {% for key, value in case.vital_signs.items %}
                        <span class="vital-sign">
                            <i class="fas fa-heartbeat me-1"></i>
                            {{ key|title }}: {{ value }}
                        </span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <!-- AI Diagnosis -->
            {% if ai_diagnosis_data.diagnosis %}
            <div class="report-section">
                <h3 class="section-title">
                    <i class="fas fa-brain"></i>AI-Powered Diagnosis
                </h3>
                
                <!-- Primary Diagnosis with Explanation -->
                <div class="diagnosis-card">
                    <div class="primary-diagnosis">
                        {{ ai_diagnosis_data.diagnosis.primary_diagnosis }}
                    </div>
                    
                    {% if ai_diagnosis_data.diagnosis.explanation %}
                    <div class="mt-3">
                        <strong><i class="fas fa-info-circle me-2"></i>What This Means:</strong>
                        <p class="text-muted">{{ ai_diagnosis_data.diagnosis.explanation }}</p>
                    </div>
                    {% endif %}
                    
                    <div class="mt-3">
                        <strong>AI Confidence Level:</strong>
                        <div class="confidence-bar">
                            <div class="confidence-fill" data-confidence="{{ ai_diagnosis_data.diagnosis.confidence|floatformat:0 }}">
                                {% widthratio ai_diagnosis_data.diagnosis.confidence 1 100 %}% Confidence
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Emergency Conditions -->
                {% if ai_diagnosis_data.diagnosis.emergency_conditions %}
                <div class="mt-3">
                    <h5 class="text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>⚠️ Emergency Alert
                    </h5>
                    {% for condition in ai_diagnosis_data.diagnosis.emergency_conditions %}
                    <div class="emergency-condition">
                        <i class="fas fa-bolt me-2"></i>{{ condition }}
                    </div>
                    {% endfor %}
                    <p class="text-danger mt-2"><strong>Action Required:</strong> Immediate medical attention needed!</p>
                </div>
                {% endif %}

                <!-- Red Flags -->
                {% if ai_diagnosis_data.diagnosis.red_flags %}
                <div class="mt-3">
                    <h5 class="text-warning">
                        <i class="fas fa-flag me-2"></i>Important Warning Signs
                    </h5>
                    {% for flag in ai_diagnosis_data.diagnosis.red_flags %}
                    <div class="red-flag">
                        <i class="fas fa-exclamation-circle me-2"></i>{{ flag.category }}: {{ flag.symptom }}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Recommended Tests - Only for Doctors -->
                {% if ai_diagnosis_data.diagnosis.recommended_tests and user.role == 'DOCTOR' %}
                <div class="mt-4">
                    <h5><i class="fas fa-vial me-2"></i>Recommended Diagnostic Tests</h5>
                    {% for test in ai_diagnosis_data.diagnosis.recommended_tests %}
                    <span class="test-badge">{{ test }}</span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endif %}
            <!-- Treatment Plan -->
            {% if ai_diagnosis_data.treatment %}
            <div class="report-section">
                <h3 class="section-title">
                    <i class="fas fa-notes-medical"></i>Treatment Plan & Recommendations
                </h3>

                <!-- Action Plan Timeline -->
                {% if ai_diagnosis_data.treatment.immediate_actions or ai_diagnosis_data.treatment.short_term_actions or ai_diagnosis_data.treatment.follow_up_actions %}
                <div class="action-timeline">
                    {% if ai_diagnosis_data.treatment.immediate_actions %}
                    <h5>Immediate Actions (0-15 minutes)</h5>
                    {% for action in ai_diagnosis_data.treatment.immediate_actions %}
                    <div class="action-item">
                        <i class="fas fa-bolt text-danger me-2"></i>
                        <strong>{{ action }}</strong>
                    </div>
                    {% endfor %}
                    {% endif %}

                    {% if ai_diagnosis_data.treatment.short_term_actions %}
                    <h5 class="mt-3">Short-term Actions (Within 1-4 hours)</h5>
                    {% for action in ai_diagnosis_data.treatment.short_term_actions %}
                    <div class="action-item">
                        <i class="fas fa-clock text-warning me-2"></i>
                        {{ action }}
                    </div>
                    {% endfor %}
                    {% endif %}

                    {% if ai_diagnosis_data.treatment.follow_up_actions %}
                    <h5 class="mt-3">Follow-up Actions</h5>
                    {% for action in ai_diagnosis_data.treatment.follow_up_actions %}
                    <div class="action-item">
                        <i class="fas fa-calendar-check text-success me-2"></i>
                        {{ action }}
                    </div>
                    {% endfor %}
                    {% endif %}
                </div>
                {% endif %}

                <!-- Medications -->
                {% if ai_diagnosis_data.treatment.medications.primary_medications or ai_diagnosis_data.treatment.medications.alternative_medications %}
                <div class="mt-4">
                    <h5><i class="fas fa-pills me-2"></i>Medication Recommendations</h5>
                    
                    {% if ai_diagnosis_data.treatment.medications.primary_medications %}
                    <h6 class="mt-3">Primary Medications:</h6>
                    {% for med in ai_diagnosis_data.treatment.medications.primary_medications %}
                    <div class="medication-card">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong class="text-success">{{ med.medication }}</strong>
                                <p class="mb-1 mt-2">
                                    <i class="fas fa-tablets me-1"></i><strong>Dosage:</strong> {{ med.dosage }}<br>
                                    <i class="fas fa-calendar me-1"></i><strong>Duration:</strong> {{ med.duration }}<br>
                                    <i class="fas fa-info-circle me-1"></i><strong>Instructions:</strong> {{ med.instructions }}
                                </p>
                                {% if med.contraindications %}
                                <p class="text-danger mb-0">
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    <strong>Warning:</strong> {{ med.contraindications }}
                                </p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% endif %}
                    
                    {% if ai_diagnosis_data.treatment.medications.alternative_medications %}
                    <h6 class="mt-3">Alternative Medications:</h6>
                    {% for med in ai_diagnosis_data.treatment.medications.alternative_medications %}
                    <div class="medication-card">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong class="text-info">{{ med.medication }}</strong>
                                <p class="mb-1 mt-2">
                                    <i class="fas fa-tablets me-1"></i><strong>Dosage:</strong> {{ med.dosage }}<br>
                                    <i class="fas fa-calendar me-1"></i><strong>Duration:</strong> {{ med.duration }}<br>
                                    <i class="fas fa-info-circle me-1"></i><strong>Instructions:</strong> {{ med.instructions }}
                                </p>
                                {% if med.contraindications %}
                                <p class="text-danger mb-0">
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    <strong>Warning:</strong> {{ med.contraindications %}
                                </p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% endif %}
                    
                    {% if ai_diagnosis_data.treatment.medications.evidence_sources %}
                    <div class="alert alert-info mt-3">
                        <small><i class="fas fa-book-medical me-2"></i><strong>Evidence Sources:</strong> 
                        {{ ai_diagnosis_data.treatment.medications.evidence_sources|join:", " }}</small>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- First Aid (Emergency Cases) -->
                {% if ai_diagnosis_data.treatment.first_aid %}
                <div class="mt-4">
                    <div class="emergency-condition">
                        <i class="fas fa-first-aid me-2"></i>
                        <strong>Emergency First Aid Protocol</strong>
                    </div>
                    {% for step in ai_diagnosis_data.treatment.first_aid %}
                    <div class="action-item mt-2">
                        {{ step }}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                <!-- Treatment Evidence Sources -->
                {% if ai_diagnosis_data.treatment.evidence_sources %}
                <div class="mt-4">
                    <h6><i class="fas fa-book-medical me-2"></i>Treatment Guidelines Used:</h6>
                    <div class="alert alert-success">
                        <ul class="mb-0">
                        {% for source in ai_diagnosis_data.treatment.evidence_sources %}
                            <li><small>{{ source }}</small></li>
                        {% endfor %}
                        </ul>
                        <small class="text-muted mt-2 d-block">
                            <i class="fas fa-check-circle me-1"></i>Treatment recommendations are based on these medical guidelines from the knowledge base.
                        </small>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Knowledge Base References - Only visible to Doctors and Experts -->
            {% if ai_diagnosis_data.retriever.sources and user.role != 'NURSE' %}
            <div class="report-section">
                <h3 class="section-title">
                    <i class="fas fa-book-medical"></i>Medical Knowledge References
                </h3>
                <p class="text-muted">
                    This diagnosis was informed by {{ ai_diagnosis_data.retriever.total_documents }} 
                    medical documents from the knowledge base:
                </p>
                {% for source in ai_diagnosis_data.retriever.sources|slice:":5" %}
                <div class="knowledge-source">
                    <i class="fas fa-file-pdf me-2"></i>
                    <strong>{{ source }}</strong>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Case Status -->
            <div class="report-section">
                <h5 class="section-title">
                    <i class="fas fa-info-circle"></i>Case Status
                </h5>
                <p><strong>Status:</strong> <span class="badge bg-info">{{ case.get_status_display }}</span></p>
                <p><strong>Priority:</strong> <span class="priority-badge priority-{{ case.priority }}">{{ case.get_priority_display }}</span></p>
                <p><strong>Nurse:</strong> {{ case.nurse.get_full_name|default:case.nurse.username }}</p>
                {% if case.doctor %}
                <p><strong>Doctor:</strong> {{ case.doctor.get_full_name|default:case.doctor.username }}</p>
                {% endif %}
                <p><strong>Created:</strong> {{ case.created_at|date:"M d, Y g:i A" }}</p>
                <p><strong>Last Updated:</strong> {{ case.updated_at|date:"M d, Y g:i A" }}</p>
            </div>

            <!-- Routing Decision -->
            {% if ai_diagnosis_data.routing %}
            <div class="report-section">
                <h5 class="section-title">
                    <i class="fas fa-route"></i>AI Routing
                </h5>
                <p><strong>Urgency Level:</strong> <span class="text-uppercase text-danger">{{ ai_diagnosis_data.routing.urgency_level }}</span></p>
                <p><strong>Urgency Score:</strong> {{ ai_diagnosis_data.routing.urgency_score }}/100</p>
                <p><strong>Reason:</strong> {{ ai_diagnosis_data.routing.routing_reason }}</p>
                {% if ai_diagnosis_data.routing.needs_doctor_review %}
                <div class="alert alert-warning">
                    <i class="fas fa-user-md me-2"></i>
                    <strong>Doctor Review Required</strong>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Actions -->
            <div class="report-section no-print">
                <h5 class="section-title">
                    <i class="fas fa-tasks"></i>Actions
                </h5>
                <div class="d-grid gap-2">
                    <a href="{% url 'diagnoses:case_list' %}" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Cases
                    </a>
                    {% if user.role == 'DOCTOR' %}
                    <a href="{% url 'diagnoses:case_review' case.id %}" class="btn btn-primary">
                        <i class="fas fa-clipboard-check me-2"></i>Review Case
                    </a>
                    {% endif %}
                    <button onclick="window.print()" class="btn btn-success">
                        <i class="fas fa-print me-2"></i>Print Report
                    </button>
                </div>
            </div>

            <!-- AI System Info -->
            <div class="report-section">
                <h5 class="section-title">
                    <i class="fas fa-robot"></i>AI System Info
                </h5>
                <p class="small text-muted">
                    <strong>System:</strong> {{ ai_diagnosis_data.multi_agent_system|default:"HealthFlow DMS v1.0" }}<br>
                    <strong>Generated:</strong> {{ ai_diagnosis_data.timestamp|slice:":19"|default:case.created_at|date:"Y-m-d H:i" }}<br>
                    <strong>Agents Used:</strong> Coordinator, Retriever, Diagnosis, Treatment
                </p>
            </div>
        </div>
    </div>
</div>

<script>
// Animate confidence bar on load
document.addEventListener('DOMContentLoaded', function() {
    const confidenceFill = document.querySelector('.confidence-fill');
    if (confidenceFill) {
        const targetWidth = confidenceFill.getAttribute('data-confidence') + '%';
        confidenceFill.style.width = '0%';
        setTimeout(() => {
            confidenceFill.style.width = targetWidth;
        }, 100);
    }
});
</script>
{% endblock %}
